<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square.css" rel="stylesheet">
  <style>
    body, html {
      font-family: 'NanumSquare', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      background-color: #ffffff;
      font-size: 25px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: none;
      box-sizing: border-box;
    }

    /* 상단 SNSB-C 헤더 */
    .top-header {
      background: #ffffff;
      color: #2c5c8e;
      padding: 4px;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      flex-shrink: 0;
      border-bottom: 2px solid #e0e0e0;
    }



    /* 메인 컨테이너 */
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      background-color: #ffffff;
    }

    /* 검사실 섹션 */
    .exam-rooms-section {
      display: flex;
      height: 37%;
      background: #ffffff;
      border-bottom: 2px solid #e0e0e0;
      flex-shrink: 0;
    }

    .exam-room {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-right: 1px solid #e0e0e0;
      padding: 10px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .exam-room:last-child {
      border-right: none;
    }

    .room-title {
      font-size: 1.6em;
      font-weight: bold;
      color: #2c5c8e;
      margin-bottom: 15px;
    }

    .room-current {
      font-size: 2.2em;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }

    .room-time {
      font-size: 1.6em;
      color: #666;
    }

    /* 다음 대상자 섹션 */
    .next-subject-section {
      background: #ffffff;
      padding: 10px;
      text-align: center;
      flex-shrink: 0;
      border-bottom: 2px solid #e0e0e0;
    }

    #next-subject-text {
      font-size: 1.4em;
      font-weight: bold;
    }

    #next-subject-text .next-label {
      color: #666 !important;
      font-size: 1.1em !important;
    }

    #next-subject-text .next-name {
      color: #2c5c8e !important;
      font-size: 1.6em !important;
    }

    /* 하단 검사 섹션 */
    .test-stations-section {
      display: flex;
      flex: 1;
      background: #ffffff;
      min-height: 0;
      flex-shrink: 0;
    }

    .test-station {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e0e0;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .test-station:last-child {
      border-right: none;
    }

    .station-title {
      font-size: 1.6em;
      font-weight: bold;
      color: #2c5c8e;
      text-align: center;
      margin-bottom: 12px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .station-current {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .current-name {
      font-size: 2.2em;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .current-time {
      font-size: 1.6em;
      color: #666;
      margin-bottom: 20px;
    }

    .next-info {
      display: flex;
      flex-direction: row; /* 한 줄로 표시 */
      justify-content: center;
      align-items: baseline; /* 텍스트 기준선 정렬 */
      padding: 15px 10px;
      border-radius: 5px;
    }

    .next-info .next-label {
      font-size: 1.4em;
      font-weight: bold;
      margin-right: 10px; /* 오른쪽 여백 추가 */
    }

    .next-info .next-name {
      font-size: 2.5em;
      font-weight: bold;
    }

    /* 검사 상태별 색상 구분 */
    /* 검사중 - 파란색 (최우선) */
    .exam-room.active,
    .test-station.active {
      background: linear-gradient(to bottom, #4c8fbd 0%, #2c5c8e 100%) !important;
      color: white !important;
    }

    .exam-room.active .room-title,
    .exam-room.active .room-current,
    .exam-room.active .room-time,
    .test-station.active .station-title,
    .test-station.active .current-name,
    .test-station.active .current-time,
    .test-station.active .current-name,
    .test-station.active .current-time {
      color: white !important;
    }

    .test-station.active .station-title {
      background: rgba(255, 255, 255, 0.1) !important;
    }

    .test-station.active .next-info {
      background: #ffffff !important;
    }

    .test-station.active .next-label {
      color: #666 !important;
    }

    .test-station.active .next-name {
      color: #2c5c8e !important;
    }

    .test-station.active .next-name .next-name-text {
      color: #2c5c8e !important;
    }

    /* 기본 - 흰색 */
    .exam-room:not(.active),
    .test-station:not(.active) {
      background: #ffffff;
      color: #333;
    }

    .exam-room:not(.active) .room-title,
    .exam-room:not(.active) .room-current,
    .exam-room:not(.active) .room-time,
    .test-station:not(.active) .station-title,
    .test-station:not(.active) .current-name,
    .test-station:not(.active) .current-time,
    .test-station:not(.active) .current-name,
    .test-station:not(.active) .current-time {
      color: #333;
    }

    .test-station:not(.active) .station-title {
      background: #f8f9fa;
    }

    .test-station:not(.active) .next-info {
      background: linear-gradient(to bottom, #4c8fbd 0%, #2c5c8e 100%);
    }

    .test-station:not(.active) .next-info .next-label,
    .test-station:not(.active) .next-info .next-name { /* .next-name-text -> .next-name 으로 수정 */
      color: #ffffff; /* !important 제거 */
    }

    /* Animations are now controlled by JavaScript to ensure reliability. */



    /* 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border: none;
      border-radius: 15px;
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
      display: flex;
      flex-direction: column;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      background: linear-gradient(to bottom, #4c8fbd 0%, #2c5c8e 100%);
      color: white;
      padding: 20px;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5em;
      font-weight: bold;
    }

    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .close:hover {
      opacity: 0.7;
    }

    .modal-body {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      max-height: calc(85vh - 140px);
    }

    .settings-section {
      margin-bottom: 20px;
    }

    .settings-section h3 {
      color: #2c5c8e;
      font-size: 1.2em;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }

    .setting-item {
      margin-bottom: 10px;
      padding: 8px 10px;
      background: #f8f9fa;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .setting-item:hover {
      background: #e9ecef;
    }

    .setting-item label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 500;
    }

    .setting-item input[type="checkbox"] {
      margin-right: 12px;
      transform: scale(1.2);
      accent-color: #2c5c8e;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .save-btn, .reset-btn, .test-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .save-btn {
      background: linear-gradient(to bottom, #4c8fbd 0%, #2c5c8e 100%);
      color: white;
    }

    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(44,92,142,0.3);
    }

    .reset-btn {
      background: #6c757d;
      color: white;
    }

    .reset-btn:hover {
      background: #5a6268;
    }

    .test-btn {
      background: #28a745;
      color: white;
    }

    .test-btn:hover {
      background: #218838;
    }

    /* 반응형 디자인 */
    @media (max-width: 1200px) {
      body, html {
        font-size: 20px;
      }
      
      .top-header {
        font-size: 1.3em;
        padding: 6px;
      }
    }

    @media (max-width: 768px) {
      body, html {
        font-size: 16px;
      }
      
      .top-header {
        font-size: 1.2em;
        padding: 5px;
      }
      
      .next-subject-section {
        font-size: 1.0em;
        padding: 8px;
      }

      .modal-content {
        width: 95%;
        margin: 5% auto;
        max-height: 90vh;
      }
      
      .modal-body {
        padding: 15px;
        max-height: calc(90vh - 120px);
      }
      
      .modal-footer {
        flex-direction: column;
        padding: 10px 15px;
      }
      
      .save-btn, .reset-btn, .test-btn {
        width: 100%;
        margin-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <!-- 상단 SNSB-C 헤더 -->
  <div class="top-header" onclick="openSettingsModal()">
    SNSB-C
  </div>

  <!-- 메인 컨테이너 -->
  <div class="main-container">
    <!-- 검사실 섹션 -->
    <div class="exam-rooms-section">
      <div class="exam-room" id="room-1">
        <div class="room-title">1번 검사실</div>
        <div class="room-current" id="room-1-current">-</div>
        <div class="room-time" id="room-1-time">-</div>
      </div>
      <div class="exam-room" id="room-2">
        <div class="room-title">2번 검사실</div>
        <div class="room-current" id="room-2-current">-</div>
        <div class="room-time" id="room-2-time">-</div>
      </div>
      <div class="exam-room" id="room-3">
        <div class="room-title">3번 검사실</div>
        <div class="room-current" id="room-3-current">-</div>
        <div class="room-time" id="room-3-time">-</div>
      </div>
    </div>

    <!-- 다음 대상자 섹션 -->
    <div class="next-subject-section">
      <div id="next-subject-text">다음 대상자 없음</div>
    </div>

    <!-- 하단 검사 섹션 (JS-Controlled) -->
    <div class="test-stations-section">
      <div class="test-station" id="station-ecg">
        <div class="station-title">심전도</div>
        <div class="station-current">
          <div class="current-name" id="ecg-current">-</div>
          <div class="current-time" id="ecg-time">-</div>
        </div>
        <div class="next-info" id="next-info-ecg">
          <span class="next-label">다음</span>
          <span class="next-name" id="ecg-next-name">대상자 없음</span>
        </div>
      </div>
      <div class="test-station" id="station-blood">
        <div class="station-title">채혈/채뇨</div>
        <div class="station-current">
          <div class="current-name" id="blood-current">-</div>
          <div class="current-time" id="blood-time">-</div>
        </div>
        <div class="next-info" id="next-info-blood">
          <span class="next-label">다음</span>
          <span class="next-name" id="blood-next-name">대상자 없음</span>
        </div>
      </div>
      <div class="test-station" id="station-physical">
        <div class="station-title">신체기능</div>
        <div class="station-current">
          <div class="current-name" id="physical-current">-</div>
          <div class="current-time" id="physical-time">-</div>
        </div>
        <div class="next-info" id="next-info-physical">
          <span class="next-label">다음</span>
          <span class="next-name" id="physical-next-name">대상자 없음</span>
        </div>
      </div>
    </div>
  </div>



  <!-- 설정 모달 -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>알림 설정</h2>
        <span class="close" onclick="closeSettingsModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3>SNSB-C 검사실</h3>
          <div class="setting-item">
            <label>
              <input type="checkbox" id="sound-snsbc" checked>
              SNSB-C 알림음
            </label>
          </div>
          <div class="setting-item">
            <label>
              <input type="checkbox" id="tts-snsbc" checked>
              SNSB-C TTS 호명
            </label>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>기타 검사</h3>
          <div class="setting-item">
            <label>
              <input type="checkbox" id="sound-ecg" checked>
              심전도 알림음
            </label>
          </div>
          <div class="setting-item">
            <label>
              <input type="checkbox" id="sound-blood" checked>
              채혈/채뇨 알림음
            </label>
          </div>
          <div class="setting-item">
            <label>
              <input type="checkbox" id="sound-physical" checked>
              신체기능 알림음
            </label>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>전체 설정</h3>
          <div class="setting-item">
            <label>
              <input type="checkbox" id="enable-all-sounds" checked>
              모든 알림음 활성화
            </label>
          </div>
          <div class="setting-item">
            <label>
              <input type="checkbox" id="enable-all-tts" checked>
              모든 TTS 호명 활성화
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="saveSettings()" class="save-btn">저장</button>
        <button onclick="resetSettings()" class="reset-btn">초기화</button>
        <button onclick="testSound()" class="test-btn">테스트</button>
      </div>
    </div>
  </div>

  <div id="player" style="position: absolute; top: -9999px; left: -9999px;"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // === SCRIPT REWRITE FOR JS-DRIVEN ANIMATION ===

    // 전역 변수
    let lastTableData = [];
    let startTimeCache = {};
    const recentlyCalled = {}; // TTS 중복 호출 방지용 캐시
    
    // 시간 타이머 관리를 위한 전역 변수들
    let timeTimers = {}; // 각 검사별 타이머 ID 저장
    let cachedStartTimes = {}; // 각 검사별 시작 시간 캐시
    let currentElapsedTimes = {}; // 각 검사별 현재 경과 시간 저장

    // --- NEW: Blinking animation state and controller ---
    const blinkTimers = {};

    function startBlinking(elementId) {
      // If a timer already exists for this element, clear it to prevent duplicates
      if (blinkTimers[elementId]) {
        clearInterval(blinkTimers[elementId].timerId);
      }

      const station = document.getElementById(elementId);
      if (!station) return;

      // Find the elements to animate within this station
      const nextInfo = station.querySelector('.next-info');
      const nextLabel = station.querySelector('.next-label');
      const nextName = station.querySelector('.next-name');

      let isBlinked = false;
      let blinkCount = 0;
      const maxBlinks = 13; // Approx 10 seconds (13 * 800ms)

      // Immediately start in the blinked state
      isBlinked = true;
      blinkCount++;
      station.style.background = 'linear-gradient(to bottom, #4c8fbd 0%, #2c5c8e 100%)';
      if (nextInfo) {
        nextInfo.style.background = '#ffffff';
        if (nextLabel) nextLabel.style.color = '#666666';
        if (nextName) nextName.style.color = '#2c5c8e';
      }

      const timerId = setInterval(() => {
        isBlinked = !isBlinked;
        blinkCount++;

        if (blinkCount > maxBlinks) {
          stopBlinking(elementId);
          return;
        }

        // Manually toggle styles
        if (isBlinked) {
          station.style.background = 'linear-gradient(to bottom, #4c8fbd 0%, #2c5c8e 100%)';
          if (nextInfo) {
            nextInfo.style.background = '#ffffff';
            if (nextLabel) nextLabel.style.color = '#666666';
            if (nextName) nextName.style.color = '#2c5c8e';
          }
        } else {
          // Reset to default styles (let CSS classes take over)
          station.style.background = '';
          if (nextInfo) {
            nextInfo.style.background = '';
            if (nextLabel) nextLabel.style.color = '';
            if (nextName) nextName.style.color = '';
          }
        }
      }, 800);

      blinkTimers[elementId] = { timerId };
    }

    function stopBlinking(elementId) {
      if (blinkTimers[elementId]) {
        clearInterval(blinkTimers[elementId].timerId);
        delete blinkTimers[elementId];

        // Ensure styles are reset when blinking stops
        const station = document.getElementById(elementId);
        if (!station) return;
        const nextInfo = station.querySelector('.next-info');
        const nextLabel = station.querySelector('.next-label');
        const nextName = station.querySelector('.next-name');

        station.style.background = '';
        if (nextInfo) {
          nextInfo.style.background = '';
          if (nextLabel) nextLabel.style.color = '';
          if (nextName) nextName.style.color = '';
        }
      }
    }
    // --- END: Blinking animation controller ---

    // YouTube Player 설정
    let player;
    const soundMap = {
      A: 'rvoCNw6ROnU', // ECG, Physical, Blood
      B: '7uCP_mq4XPM', // SNSB-C 1
      C: 'oQZIW4RjCOM', // SNSB-C 2
      D: 'LjrzAaGLUGU'  // SNSB-C 3
    };
    const snsbcSoundMap = {
      'chldlsrb07@gmail.com': soundMap.B,
      'wjdgh7946@gmail.com': soundMap.C,
      'a93430506@gmail.com': soundMap.D
    };

    // 설정 관리 시스템
    let settings = {
      soundSnsbc: true,
      ttsSnsbc: true,
      soundEcg: true,
      soundBlood: true,
      soundPhysical: true,
      enableAllSounds: true,
      enableAllTts: true
    };

    // YouTube Player 초기화
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '1',
        width: '1',
        events: {
          'onReady': onPlayerReady
        }
      });
    }

    function onPlayerReady(event) {
      event.target.setVolume(100);
    }

    function playSound(videoId) {
      if (player && typeof player.loadVideoById === 'function') {
        player.loadVideoById(videoId);
      }
    }

    // 이름을 자연스럽게 발음하기 위한 SSML 변환 함수
    function formatNameForTTS(name) {
      return `<speak>${name} 님.<break time="0.4s"/>${name} 님.</speak>`;
    }

    // Google Cloud TTS를 호출하여 음성을 재생하는 함수
    function speak(text) {
      const ssmlText = text.startsWith('<speak>') ? text : formatNameForTTS(text);
      
      google.script.run
        .withSuccessHandler(function(audioContent) {
          if (audioContent) {
            playAudioFromBase64(audioContent);
          }
        })
        .withFailureHandler(function(error) {
          console.error('TTS 에러:', error.message);
        })
        .getTTSAudioNew(ssmlText);
    }

    // Base64로 인코딩된 오디오 데이터를 재생하는 함수
    function playAudioFromBase64(base64Data) {
      try {
        const audioSrc = `data:audio/mp3;base64,${base64Data}`;
        const audio = new Audio(audioSrc);
        audio.volume = 1.0;
        audio.play().catch(error => {
          console.error('오디오 재생 실패:', error);
        });
      } catch (e) {
        console.error('오디오 재생 에러:', e);
      }
    }

    // 시작시간 파싱 함수
    function parseStartTime(str) {
      if (!str) return null;
      if (/^\d{1,2}:\d{2}:\d{2}$/.test(str)) {
        const now = new Date();
        const [h, m, s] = str.split(":").map(Number);
        return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, s);
      }
      const d = new Date(str);
      if (!isNaN(d.getTime())) return d;
      return null;
    }

    // 경과시간 계산 함수
    function getElapsedTime(startTimeStr) {
      if (!startTimeStr) return '-';
      const startTime = parseStartTime(startTimeStr);
      if (!startTime) return '-';
      
      const now = new Date();
      const diff = Math.floor((now - startTime) / 1000);
      if (diff < 0) return '-';
      
      const m = Math.floor(diff / 60);
      const s = diff % 60;
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // 새로운 시간 타이머 관리 함수들
    function startTimeTimer(testType, startTimeStr, elementId) {
      // 기존 타이머가 있으면 정리
      if (timeTimers[testType]) {
        clearInterval(timeTimers[testType]);
      }
      
      const startTime = parseStartTime(startTimeStr);
      if (!startTime) {
        currentElapsedTimes[testType] = '-';
        updateTimeDisplay(elementId, '-');
        return;
      }
      
      // 초기 경과 시간 계산
      const updateTime = () => {
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        if (diff < 0) {
          currentElapsedTimes[testType] = '-';
          updateTimeDisplay(elementId, '-');
          return;
        }
        
        const m = Math.floor(diff / 60);
        const s = diff % 60;
        const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        currentElapsedTimes[testType] = timeStr;
        updateTimeDisplay(elementId, timeStr);
      };
      
      // 즉시 한 번 실행
      updateTime();
      
      // 1초마다 업데이트
      timeTimers[testType] = setInterval(updateTime, 1000);
    }
    
    function stopTimeTimer(testType) {
      if (timeTimers[testType]) {
        clearInterval(timeTimers[testType]);
        delete timeTimers[testType];
        delete currentElapsedTimes[testType];
        delete cachedStartTimes[testType];
      }
    }
    
    function updateTimeDisplay(elementId, timeStr) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = timeStr;
      }
    }

    // 시간 포맷팅 함수
    function formatTime(timeStr) {
      if (!timeStr) return '-';
      if (/^\d{1,2}:\d{2}:\d{2}$/.test(timeStr)) {
        return timeStr.substring(0, 5); // HH:mm만 표시
      }
      return timeStr;
    }

    // 설정 기반 사운드 재생
    function playSoundWithSettings(videoId, type = 'general') {
      if (!settings.enableAllSounds) return;
      
      switch(type) {
        case 'snsbc':
          if (!settings.soundSnsbc) return;
          break;
        case 'ecg':
          if (!settings.soundEcg) return;
          break;
        case 'blood':
          if (!settings.soundBlood) return;
          break;
        case 'physical':
          if (!settings.soundPhysical) return;
          break;
      }
      
      playSound(videoId);
    }

    // 설정 기반 TTS 호출
    function speakWithSettings(text, type = 'general') {
      if (!settings.enableAllTts) return;
      
      switch(type) {
        case 'snsbc':
          if (!settings.ttsSnsbc) return;
          break;
      }
      
      speak(text);
    }

    // 데이터 렌더링 함수
    function renderData(data) {
      const tableData = data.tableData;
      const nextUpData = data.nextUp;

      if (!tableData || tableData.length === 0) {
        return;
      }

      const idx = {
        이름: 0,
        ID: 1,
        심전도: 2,
        신체기능: 3,
        SNSBC: 4,
        심전도시작: 5,
        신체기능시작: 6,
        SNSBC시작: 7,
        수행자: 8,
        채혈: 9,
        채혈시작: 10,
        채혈종료: 11,
        채뇨: 12,
        신체계측: 13
      };

      const prevDataMap = new Map((window.lastTableData || []).map(row => [row[1], row]));
      const currentData = tableData.slice(1);

      for (const currentRow of currentData) {
        const prevRow = prevDataMap.get(currentRow[1]);
        if (!prevRow) continue;

        // SNSB-C 완료
        if (prevRow[idx.SNSBC] === '검사중' && currentRow[idx.SNSBC] === '완료') {
          const performerEmail = currentRow[idx.수행자];
          const videoId = snsbcSoundMap[performerEmail];
          playSoundWithSettings(videoId, 'snsbc');
          let roomNumber = 1;
          if (performerEmail === 'wjdgh7946@gmail.com') roomNumber = 2;
          else if (performerEmail === 'a93430506@gmail.com') roomNumber = 3;
          startBlinking(`room-${roomNumber}`);
          setTimeout(() => {
            if (nextUpData && nextUpData.snsbc && nextUpData.snsbc !== '-') {
              const nextPersonName = nextUpData.snsbc.replace(/<[^>]*>/g, '');
              const callKey = `snsbc-${nextPersonName}`;
              if (!recentlyCalled[callKey] || (new Date() - recentlyCalled[callKey] > 60000)) {
                speakWithSettings(nextPersonName, 'snsbc');
                recentlyCalled[callKey] = new Date();
              }
            }
          }, 1000);
        }

        // 심전도 완료
        if (prevRow[idx.심전도] === '검사중' && currentRow[idx.심전도] === '완료') {
          playSoundWithSettings(soundMap.A, 'ecg');
          startBlinking('station-ecg');
        }
        // 신체기능 완료
        if (prevRow[idx.신체기능] === '검사중' && currentRow[idx.신체기능] === '완료') {
          playSoundWithSettings(soundMap.A, 'physical');
          startBlinking('station-physical');
        }
        // 채혈 완료
        if (prevRow[idx.채혈] === '검사중' && currentRow[idx.채혈] === '완료') {
          playSoundWithSettings(soundMap.A, 'blood');
          startBlinking('station-blood');
        }
      }

      window.lastTableData = currentData;

      const examRooms = {
        'room-1': { current: '-', time: '-', active: false, startTime: null },
        'room-2': { current: '-', time: '-', active: false, startTime: null },
        'room-3': { current: '-', time: '-', active: false, startTime: null }
      };
      const testStations = {
        ecg: { current: '-', time: '-', next: '-', active: false, startTime: null },
        blood: { current: [], time: '-', next: '-', active: false, startTime: null },
        physical: { current: '-', time: '-', next: '-', active: false, startTime: null }
      };

      for (let i = 1; i < tableData.length; i++) {
        const row = tableData[i];
        const name = row[idx.이름].replace(/<span class="status-dot [^"]*"><\/span> /, '');
        if (row[idx.SNSBC] === '검사중' && row[idx.수행자]) {
          const performerEmail = row[idx.수행자];
          let roomNumber = 1;
          if (performerEmail === 'wjdgh7946@gmail.com') roomNumber = 2;
          if (performerEmail === 'a93430506@gmail.com') roomNumber = 3;
          const roomKey = `room-${roomNumber}`;
          examRooms[roomKey] = { 
            current: name, 
            time: getElapsedTime(row[idx.SNSBC시작]), 
            active: true, 
            startTime: row[idx.SNSBC시작] 
          };
        }
        if (row[idx.심전도] === '검사중') {
          testStations.ecg.current = name;
          testStations.ecg.time = getElapsedTime(row[idx.심전도시작]);
          testStations.ecg.active = true;
          testStations.ecg.startTime = row[idx.심전도시작];
        }
        if (row[idx.채혈] === '검사중') {
          testStations.blood.current.push(name);
          testStations.blood.time = getElapsedTime(row[idx.채혈시작]);
          testStations.blood.active = true;
          testStations.blood.startTime = row[idx.채혈시작];
        }
        if (row[idx.신체기능] === '검사중') {
          testStations.physical.current = name;
          testStations.physical.time = getElapsedTime(row[idx.신체기능시작]);
          testStations.physical.active = true;
          testStations.physical.startTime = row[idx.신체기능시작];
        }
      }

      if (nextUpData) {
        testStations.ecg.next = nextUpData.ecg || '-';
        testStations.blood.next = nextUpData.blood || '-';
        testStations.physical.next = nextUpData.physical || '-';
      }

      updateExamRooms(examRooms);
      updateTestStations(testStations);
      updateNextSubject(nextUpData);
    }

    function updateExamRooms(rooms) {
      Object.keys(rooms).forEach(roomKey => {
        const room = document.getElementById(roomKey);
        const currentEl = document.getElementById(`${roomKey}-current`);
        const timeEl = document.getElementById(`${roomKey}-time`);
        const roomData = rooms[roomKey];
        
        currentEl.textContent = roomData.current;
        
        // 시간 타이머 관리
        if (roomData.active && roomData.startTime) {
          // 시작 시간이 변경되었는지 확인
          if (cachedStartTimes[roomKey] !== roomData.startTime) {
            cachedStartTimes[roomKey] = roomData.startTime;
            startTimeTimer(roomKey, roomData.startTime, `${roomKey}-time`);
          }
        } else {
          // 검사가 끝났으면 타이머 정리
          stopTimeTimer(roomKey);
          timeEl.textContent = '-';
        }
        
        room.classList.remove('active');
        if (roomData.active) {
          room.classList.add('active');
        }
      });
    }

    function updateTestStations(stations) {
      Object.keys(stations).forEach(stationKey => {
        const station = document.getElementById(`station-${stationKey}`);
        const currentEl = document.getElementById(`${stationKey}-current`);
        const timeEl = document.getElementById(`${stationKey}-time`);
        const nextNameEl = document.getElementById(`${stationKey}-next-name`);
        const stationData = stations[stationKey];

        if (stationKey === 'blood' && Array.isArray(stationData.current)) {
          if (stationData.current.length === 0) currentEl.textContent = '-';
          else if (stationData.current.length === 1) currentEl.textContent = stationData.current[0];
          else currentEl.innerHTML = stationData.current.join('<br>');
        } else {
          currentEl.textContent = stationData.current;
        }
        
        // 시간 타이머 관리
        if (stationData.active && stationData.startTime) {
          // 시작 시간이 변경되었는지 확인
          if (cachedStartTimes[stationKey] !== stationData.startTime) {
            cachedStartTimes[stationKey] = stationData.startTime;
            startTimeTimer(stationKey, stationData.startTime, `${stationKey}-time`);
          }
        } else {
          // 검사가 끝났으면 타이머 정리
          stopTimeTimer(stationKey);
          timeEl.textContent = '-';
        }
        
        const nextText = stationData.next === '-' ? '대상자 없음' : stationData.next;
        if (nextNameEl) {
            nextNameEl.textContent = nextText;
        }
        station.classList.remove('active');
        if (stationData.active) {
          station.classList.add('active');
        }
      });
    }

    function updateNextSubject(nextUpData) {
      const nextSubjectEl = document.getElementById('next-subject-text');
      if (nextUpData && nextUpData.snsbc && Array.isArray(nextUpData.snsbc) && nextUpData.snsbc.length > 0) {
        const names = nextUpData.snsbc.join(', ');
        nextSubjectEl.innerHTML = '<span class="next-label">다음 </span><span class="next-name">' + names + '</span>';
      } else {
        nextSubjectEl.innerHTML = '<span class="next-label">다음 </span><span class="next-name">대상자 없음</span>';
      }
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('notificationSettings');
      if (savedSettings) {
        settings = { ...settings, ...JSON.parse(savedSettings) };
      }
      applySettingsToUI();
    }

    function applySettingsToUI() {
      document.getElementById('sound-snsbc').checked = settings.soundSnsbc;
      document.getElementById('tts-snsbc').checked = settings.ttsSnsbc;
      document.getElementById('sound-ecg').checked = settings.soundEcg;
      document.getElementById('sound-blood').checked = settings.soundBlood;
      document.getElementById('sound-physical').checked = settings.soundPhysical;
      document.getElementById('enable-all-sounds').checked = settings.enableAllSounds;
      document.getElementById('enable-all-tts').checked = settings.enableAllTts;
    }

    function openSettingsModal() {
      document.getElementById('settingsModal').style.display = 'block';
      loadSettings();
      setupSettingsEventListeners();
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    function saveSettings() {
      settings.soundSnsbc = document.getElementById('sound-snsbc').checked;
      settings.ttsSnsbc = document.getElementById('tts-snsbc').checked;
      settings.soundEcg = document.getElementById('sound-ecg').checked;
      settings.soundBlood = document.getElementById('sound-blood').checked;
      settings.soundPhysical = document.getElementById('sound-physical').checked;
      settings.enableAllSounds = document.getElementById('enable-all-sounds').checked;
      settings.enableAllTts = document.getElementById('enable-all-tts').checked;
      localStorage.setItem('notificationSettings', JSON.stringify(settings));
      alert('설정이 저장되었습니다.');
      closeSettingsModal();
    }

    function resetSettings() {
      if (confirm('모든 설정을 초기화하시겠습니까?')) {
        settings = {
          soundSnsbc: true, ttsSnsbc: true, soundEcg: true, soundBlood: true,
          soundPhysical: true, enableAllSounds: true, enableAllTts: true
        };
        localStorage.removeItem('notificationSettings');
        applySettingsToUI();
        alert('설정이 초기화되었습니다.');
      }
    }

    function testSound() {
      if (settings.enableAllSounds) {
        playSound(soundMap.A);
        setTimeout(() => {
          if (settings.enableAllTts) speak('최인규');
        }, 1000);
      } else {
        alert('알림음이 비활성화되어 있습니다.');
      }
    }

    function setupSettingsEventListeners() {
      const enableAllSounds = document.getElementById('enable-all-sounds');
      if (enableAllSounds) {
        enableAllSounds.addEventListener('change', function() {
          const isChecked = this.checked;
          document.getElementById('sound-snsbc').checked = isChecked;
          document.getElementById('sound-ecg').checked = isChecked;
          document.getElementById('sound-blood').checked = isChecked;
          document.getElementById('sound-physical').checked = isChecked;
        });
      }
      const enableAllTts = document.getElementById('enable-all-tts');
      if (enableAllTts) {
        enableAllTts.addEventListener('change', function() {
          document.getElementById('tts-snsbc').checked = this.checked;
        });
      }
    }

    window.onclick = function(event) {
      if (event.target === document.getElementById('settingsModal')) {
        closeSettingsModal();
      }
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') closeSettingsModal();
    });

    function fetchAndRender() {
      google.script.run.withSuccessHandler(renderData).getFilteredTableData();
    }

    fetchAndRender();
    loadSettings();
    setInterval(fetchAndRender, 1500);

    document.addEventListener('click', function() {}, { once: true });
  </script>
</body>
</html>